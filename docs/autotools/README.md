# Autotools-based PHP build system

This is a brief introduction to Autotools and how it is used in the PHP build
system.

## Index

* [1. Introduction](#1-introduction)
* [2. Directory structure](#2-directory-structure)
* [3. Build system diagram](#3-build-system-diagram)
* [4. Build requirements](#4-build-requirements)
* [5. The configure command-line options](#5-the-configure-command-line-options)
* [6. Determining platform](#6-determining-platform)
* [7. Common checks](#7-common-checks)
  * [7.1. Testing if program works](#71-testing-if-program-works)
    * [7.1.1. AC\_COMPILE\_IFELSE](#711-ac_compile_ifelse)
    * [7.1.2. AC\_LINK\_IFELSE](#712-ac_link_ifelse)
    * [7.1.3. AC\_RUN\_IFELSE](#713-ac_run_ifelse)
  * [7.2. Functions](#72-functions)
* [8. GNU Autoconf Archive](#8-gnu-autoconf-archive)
* [9. Parser and lexer files](#9-parser-and-lexer-files)
* [10. PHP installation](#10-php-installation)
* [11. See more](#11-see-more)

## 1. Introduction

\*nix build system (Linux, macOS, FreeBSD, OpenBSD, Solaris, Haiku, etc.) in PHP
uses [Autoconf](https://www.gnu.org/software/autoconf/) to build a `configure`
shell script that further creates a `Makefile` to build sources to executable
binaries.

```sh
# Create Autotools configure script
./buildconf

# Configure PHP build and create Makefile
./configure

# Build PHP
make
```

The `buildconf` is a simple shell script wrapper around `autoconf` and
`autoheader` command-line tools. It checks required Autoconf version, creates
`configure` command-line script and `main/php_config.h.in` header template.

When running the `./configure`, many checks are done based on the host and
targeted system. Things like C headers availability, C symbols, required library
dependencies, etc.

The `configure` script creates `Makefile` where the `make` command then builds
binary files from C source files. You can optionally pass the `-j` option with
the number of simultaneous jobs so the build runs faster in parallel.

```sh
make -j 10
```

When compiling is done, the tests can be run with:

```sh
make TEST_PHP_ARGS=-j10 test
```

> [!NOTE]
> Number of simultaneous jobs is often the number of available logical CPU cores
> (a.k.a threads) of the build machine and can be also automatically calculated
> using the `$(nproc)` on Linux, or `$(sysctl -n hw.ncpu)` on macOS and
> BSD-based systems.
>
> ```sh
> make -j $(nproc)
> ```

PHP \*nix build system is pretty much standard GNU Autotools build system with
few customizations. It doesn't use Automake and it bundles some 3rd party files
for easier installation across various systems out there without requiring
installation dependencies. Autotools is a veteran build system present since
early C/C++ days. It is used for most Linux ecosystem out there and it might
cause issues for C developers today.

## 2. Directory structure

PHP build system is a collection of various files across the php-src repository:

```sh
ðŸ“‚ <php-src>
â””â”€ðŸ“‚ build
  â”œâ”€ðŸ“„ ax_*.m4           # https://github.com/autoconf-archive/autoconf-archive
  â”œâ”€ðŸ“„ config-stubs      # Adds extension and SAPI config*.m4 stubs to configure
  â”œâ”€ðŸ“„ config.guess      # https://git.savannah.gnu.org/cgit/config.git
  â”œâ”€ðŸ“„ config.sub        # https://git.savannah.gnu.org/cgit/config.git
  â”œâ”€ðŸ“„ genif.sh          # Generator for the internal_functions* files
  â”œâ”€ðŸ“„ libtool.m4        # Forked https://git.savannah.gnu.org/cgit/libtool.git
  â”œâ”€ðŸ“„ ltmain.sh         # Forked https://git.savannah.gnu.org/cgit/libtool.git
  â”œâ”€ðŸ“„ Makefile.global   # Root Makefile template when configure is run
  â”œâ”€ðŸ“„ order_by_dep.awk  # Used by genif.sh
  â”œâ”€ðŸ“„ php.m4            # PHP Autoconf macros
  â”œâ”€ðŸ“„ pkg.m4            # https://gitlab.freedesktop.org/pkg-config/pkg-config
  â”œâ”€ðŸ“„ print_include.awk # Used by genif.sh
  â””â”€ðŸ“„ shtool            # https://www.gnu.org/software/shtool/
â””â”€ðŸ“‚ ext
  â””â”€ðŸ“‚ bcmath
    â””â”€ðŸ“„ config.m4       # Extension's Autoconf file
  â””â”€ðŸ“‚ date
    â””â”€ðŸ“„ config0.m4      # Suffix 0 priority adds file before other config.m4 extension files
  â””â”€ðŸ“‚ mysqlnd
    â””â”€ðŸ“„ config9.m4      # Suffix 9 priority adds file after other config.m4 files
  â””â”€ðŸ“‚ opcache
    â””â”€ðŸ“‚ jit
      â””â”€ðŸ“„ Makefile.frag # Makefile fragment for OPcache Jit
    â””â”€ðŸ“„ config.m4       # Autoconf file for OPcache extension
â””â”€ðŸ“‚ main
  â”œâ”€ðŸ“„ build-defs.h      # Generated by configure
  â”œâ”€ðŸ“„ build-defs.h.in   # Template for build definitions
  â”œâ”€ðŸ“„ php_config.h      # Generated by configure
  â”œâ”€ðŸ“„ php_config.h.in   # Generated header template by buildconf
  â””â”€ðŸ“„ php_version.h     # Generated by release managers using `configure`
â”œâ”€ðŸ“‚ pear
â””â”€ðŸ“‚ sapi
  â””â”€ðŸ“‚ cli
    â””â”€ðŸ“„ config.m4       # Autoconf M4 file for SAPI
â”œâ”€ðŸ“‚ scripts
â””â”€ðŸ“‚ TSRM
  â””â”€ðŸ“„ threads.m4        # Autoconf macros for pthreads
â””â”€ðŸ“‚ Zend
  â”œâ”€ðŸ“„ Makefile.frag     # Makefile fragment for Zend Engine
  â””â”€ðŸ“„ Zend.m4           # Autoconf macros for Zend Engine
â”œâ”€ðŸ“„ buildconf           # Wrapper for autoconf and autoheader tools
â””â”€ðŸ“„ configure.ac        # Autoconf main input file for creating configure script
```

## 3. Build system diagram

![PHP *nix build system using Autotools](/docs/images/autotools.svg)

## 4. Build requirements

Before you can build PHP on Linux and other Unix-like systems, you must first
install certain third-party requirements. It's important to note that the names
of these requirements may vary depending on your specific system. For the sake
of simplicity, we will use generic names here. When building PHP from source,
one crucial requirement is a library containing development files. Such
libraries are typically packaged under names like `libfoo-dev`, `libfoo-devel`,
or similar conventions. For instance, to install the `libxml2` library, you
would look for the `libxml2-dev` (or `libxml2-devel`) package.

Required:

* autoconf
* make
* gcc
* g++
* pkg-config
* libxml2
* libsqlite3

Additionally required when building from Git repository source code:

* bison
* re2c

## 5. The configure command-line options

Configuration can be passed on the command line at the configuration phase:

```sh
./configure VAR=VALUE --enable-FEATURE --with-PACKAGE
```

With Autoconf, there are two main types of command-line options for the
`configure` script (`--enable-FEATURE` and `--with-PACKAGE`):

* `--enable-FEATURE[=ARG]` and its belonging opposite `--disable-FEATURE`

  `--disable-FEATURE` is the same as `--enable-FEATURE=no`

  These normally don't require 3rd party library or package installed on the
  system. For some extensions, PHP bundles 3rd party dependencies in the
  extension itself. For example, `bcmath`, `gd`, etc.

* `--with-PACKAGE[=ARG]` and its belonging opposite `--without-PACKAGE`

  `--without-PACKAGE` is the same as `--with-PACKAGE=no`

  These require 3rd party package installed on the system. PHP has even some
  libraries bundled in PHP source code. For example, the PCRE library and
  similar.

Other custom options that don't follow this pattern are used for adjusting
specific features during the build process.

See `./configure --help` for all available configuration options and variables.
Configure options for all PHP versions are listed also in the
[Autotools directory](/docs/autotools/configure-help/).

Some common arguments can be passed to command-line options:

* To build extension as shared: `--enable-EXT=shared` or `--with-EXT=shared`.
* Some options accept multiple arguments separated by comma (`,`). For example,
  passing the library location and similar: `--with-EXT=shared,/usr`

## 6. Determining platform

With Autotools there are several shell variables that help determine the
platform characteristics such as CPU, operating system and vendor name. When
using macros `AC_CANONICAL_BUILD`, `AC_CANONICAL_HOST`, and
`AC_CANONICAL_TARGET` in the M4 files, `config.sub` and `config.sub` scripts
help determine the values of variables `build_alias`, `host_alias`, and
`target_alias`.

Users can also manually override these variables for their specific case using
the `--build`, `--host`, and `--target` configure options.

In M4 files platform can be then determined using above shell variables in
variety of ways:

```m4
AS_CASE([$host_alias], [*freebsd*|*openbsd*],
  [AC_MSG_NOTICE([Action that is run only on FreeBSD and OpenBSD systems.])])
```

## 7. Common checks

### 7.1. Testing if program works

There are 3 main Autoconf macros that check if certain test code is successful.

Let's check a simple C program:

```c
#include <stdio.h>

int main(void)
{
    printf("Hello World");

    return 0;
}
```

#### 7.1.1. AC_COMPILE_IFELSE

```m4
AC_COMPILE_IFELSE([AC_LANG_PROGRAM([#include <stdio.h>],
  [printf("Hello World")])],
  [php_cv_func_printf_works=yes],
  [php_cv_func_printf_works=no])
```

The `AC_LANG_PROGRAM` macro will expand this into something like this:

```c
#include <stdio.h>

int main(void)
{
  printf("Hello World")
  ;
  return 0;
}
```

The `AC_COMPILE_IFELSE` will run the compilation step, for example:

```sh
gcc -o out -c hello_world.c
```

#### 7.1.2. AC_LINK_IFELSE

```m4
AC_LINK_IFELSE([AC_LANG_PROGRAM([#include <stdio.h>],
  [printf("Hello World")])],
  [php_cv_func_printf_works=yes],
  [php_cv_func_printf_works=no])
```

This will run compilation and linking:

```sh
gcc -o out hello_world.c
```

#### 7.1.3. AC_RUN_IFELSE

This will compile, link and also run the program to check if the return code is
0.

Issue with `AC_RUN_IFELSE` is when doing so-called cross-compilation. That is
building C software on one platform with purpose of running it on some other
platform. In this case the program cannot be run and we cannot be sure of if it
is running successfully or not.

```m4
AC_RUN_IFELSE([AC_LANG_PROGRAM([#include <stdio.h>],
  [printf("Hello World")])],
  [php_cv_func_printf_works=yes],
  [php_cv_func_printf_works=no],
  [php_cv_func_printf_works=cross-compiling])
```

This does something like this:

```sh
gcc -o out hello_world.c
./out
```

### 7.2. Functions

Testing if function exists within the given header.

A common way to check for function is using the `AC_CHECK_FUNC` or
`AC_CHECK_FUNCS` macros. These check if the linker sees the function in the
usual libraries (libc and the ones appended to the `LIBS` variable). However,
many times, functions also have their belonging headers, so it makes sense to
check for both using this:

```m4
AC_CHECK_HEADER([priv.h], [AC_CHECK_FUNCS([setpflags])])
```

This first checks if header `priv.h` exists, and if so, it then checks if linker
sees the function. They can be used like this:

```c
#ifdef HAVE_SETPFLAGS
# include <priv.h>
#endif

/* ... */

/* Call setpflags. */
#ifdef HAVE_SETPFLAGS
    setpflags(...)
#else
    /* ... */
#endif
```

## 8. GNU Autoconf Archive

To reuse the code there is a community collection of Autoconf macros available
at [autoconf-archive](https://github.com/autoconf-archive/autoconf-archive).

PHP is not using Automake so it includes them like this in `configure.ac`:

```m4
m4_include([build/ax_..._.m4])
m4_include([build/...macro.m4])
# ...
```

They can be than called and expanded in the m4 code:

```m4
AX_MACRO_CALL(...)
```

When using Automake, these can be automatically included like this:

```m4
AC_CONFIG_MACRO_DIR([path/to/m4/dir])
```

However, the `aclocal` from Automake is needed for this to work.

## 9. Parser and lexer files

Parser and lexer files are generated upon the build step (`make`) with `bison`
and `re2c` tools based on the targets in `Makefile.frag` files.

There is also a helper shell script available that generates these files when
developing or releasing PHP source code, otherwise they are generated during the
build phase upon the `make` invocation.

```sh
./scripts/dev/genfiles
```

Autotools-based PHP build system files related to `bison` and `re2c`:

```sh
ðŸ“‚ <php-src>
â””â”€ðŸ“‚ build
  â””â”€ðŸ“„ php.m4               # Autoconf macros with Bison and re2c macros
â””â”€ðŸ“‚ ext
  â””â”€ðŸ“‚ json
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
  â””â”€ðŸ“‚ pdo
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
  â””â”€ðŸ“‚ pdo_mysql
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
  â””â”€ðŸ“‚ pdo_pgsql
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
  â””â”€ðŸ“‚ pdo_sqlite
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
  â””â”€ðŸ“‚ phar
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
  â””â”€ðŸ“‚ standard
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
â””â”€ðŸ“‚ sapi
  â””â”€ðŸ“‚ phpdbg
    â””â”€ðŸ“„ Makefile.frag      # Makefile fragment
â””â”€ðŸ“‚ scripts
  â””â”€ðŸ“‚ dev
    â””â”€ðŸ“„ genfiles           # Parser and lexer files generator helper
â””â”€ðŸ“‚ Zend
  â””â”€ðŸ“„ Makefile.frag        # Part of Makefile related to Zend files
â””â”€ðŸ“„ configure.ac           # Minimum Bison and re2c versions settings
```

## 10. PHP installation

> [!CAUTION]
> **Before running the `make install` command, be aware that files will be
> copied outside of the current build directory.**

The default way to install PHP using Autotools across the system directories can
be done like this:

```sh
# Build configure script:
./buildconf

# Configure PHP build:
./configure --prefix=/usr

# Build PHP in parallel:
make -j$(nproc)

# Run tests in parallel:
make TEST_PHP_ARGS=-j$(nproc) test

# Finally, copy built files to their system locations:
make INSTALL_ROOT=/stage install
```

The optional `--prefix` configure option sets the location where the built files
layout is put. Default prefix is `/usr/local`. The optional `INSTALL_ROOT`
environment variable can set the parent location where the prefixed built files
layout will be put. By default, it is empty and it is usually used to set the
stage directory to perform additional tasks on the built files before being
packaged or distributed.

> [!NOTE]
> The `INSTALL_ROOT` variable name is used in PHP from the early Autotools days.
> GNU standards, CMake, and other build systems use a more common name
> [`DESTDIR`](https://www.gnu.org/prep/standards/html_node/DESTDIR.html).

The files are then copied to a predefined directory structure. PHP Autotools has
another optional configure option `--with-layout=[GNU|PHP]` (GNU or PHP layout).
It defines the installation directory structure. By default, it is set to a PHP
style directory structure.

Directory locations can be adjusted with several Autoconf default options. Here
only those relevant to PHP are listed:

* `--prefix=PREFIX` - install architecture-independent files in PREFIX;
  Default: `/usr/local`
* `--exec-prefix=EPREFIX` - install architecture-dependent files in EPREFIX;
  Default: `<PREFIX>`
* `--bindir=DIR` - set the user executables location;
  Default: `EXPREFIX/bin`
* `--sbindir=DIR` - set the system root executables location;
  Default: `EPREFIX/sbin`
* `--sysconfdir=DIR` - set the read-only single-machine data location;
  Default: `PREFIX/etc`
* `--localstatedir=DIR` - set the modifiable single-machine data location;
  Default: `PREFIX/var`
* `--runstatedir=DIR` - set the modifiable per-process data location;
  Default: `LOCALSTATEDIR/run`; (Autoconf 2.70+)
* `--libdir=DIR` - set the object code libraries location;
  Default: `EPREFIX/lib`
* `--includedir=DIR` - set the project C header files location;
  Default: `PREFIX/include`
* `--datarootdir=DIR` - set read-only architecture-independent data root;
  Default: `PREFIX/share`
* `--datadir=DIR` - set read-only architecture-independent data location;
  Default: `DATAROOTDIR`
* `--mandir=DIR` - set the man documentation location;
  Default: `DATAROOTDIR/man`

When packaging the PHP built files for certain system, additional environment
variables can help customize the installation locations and PHP package
information:

* `EXTENSION_DIR` - absolute path that overrides path to extensions shared
  objects (`.so`, `.dll`... files). By default, it is set to
  `/usr/local/lib/php/extensions/no-debug-non-zts-20230901` or
  `/usr/local/lib/php/20230901`, when using the `--with-layout=GNU`. To override
  it in the context of the prefix, it can be also set like this:

  ```sh
  ./configure --prefix=/usr EXTENSION_DIR=\${prefix}/lib/php/extensions
  ```

Common practice is to also add program prefix and suffix (for example, to have
`php84` and similar):

* `--program-prefix=PREFIX` - prepends built binaries with given prefix.
* `--program-suffix=SUFFIX` - appends suffix to binaries.

```sh
./configure \
  PHP_BUILD_SYSTEM="Acme Linux" \
  PHP_BUILD_PROVIDER="Acme" \
  PHP_BUILD_COMPILER="GCC" \
  PHP_BUILD_ARCH="x86_64" \
  PHP_EXTRA_VERSION="-acme" \
  EXTENSION_DIR=/path/to/php/extensions \
  --with-layout=GNU \
  --with-pear=\${datadir}/pear \
  --localstatedir=/var \
  --sysconfdir=/etc \
  --program-suffix=84 \
  # ...
```

See `./configure --help` for more information on how to adjust these locations.

Default PHP Autotools directory structure with GNU layout (`--with-layout=GNU`):

```sh
ðŸ“¦ <INSTALL_ROOT>                # ðŸ“¦                             # Stage directory
â””â”€ðŸ“‚ ${prefix}                   # â””â”€ðŸ“‚ /usr/local                # Installation prefix
  â”œâ”€ðŸ“‚ ${bindir}                 #   â”œâ”€ðŸ“‚ bin                     # Executable binary directory
  â””â”€ðŸ“‚ ${sysconfdir}             #   â””â”€ðŸ“‚ etc                     # System configuration directory
    â”œâ”€ðŸ“‚ php-fpm.d               #     â”œâ”€ðŸ“‚ php-fpm.d             # PHP FPM configuration directory
    â”œâ”€ðŸ“„ pear.conf               #     â”œâ”€ðŸ“„ pear.conf             # PEAR configuration file
    â””â”€ðŸ“„ php-fpm.conf.default    #     â””â”€ðŸ“„ php-fpm.conf.default  # PHP FPM configuration
  â””â”€ðŸ“‚ ${includedir}             #   â””â”€ðŸ“‚ include                 # System include directory
    â””â”€ðŸ“‚ php                     #     â””â”€ðŸ“‚ php                   # PHP headers
      â”œâ”€ðŸ“‚ ext                   #       â”œâ”€ðŸ“‚ ext                 # PHP extensions header files
      â”œâ”€ðŸ“‚ main                  #       â”œâ”€ðŸ“‚ main                # PHP main binding header files
      â”œâ”€ðŸ“‚ sapi                  #       â”œâ”€ðŸ“‚ sapi                # PHP SAPI header files
      â”œâ”€ðŸ“‚ TSRM                  #       â”œâ”€ðŸ“‚ TSRM                # TSRM header files
      â””â”€ðŸ“‚ Zend                  #       â””â”€ðŸ“‚ Zend                # Zend Engine header files
  â””â”€ðŸ“‚ ${libdir}                 #   â””â”€ðŸ“‚ lib
    â””â”€ðŸ“‚ php                     #     â””â”€ðŸ“‚ php                   # PHP shared libraries, build files, PEAR
      â”œâ”€ðŸ“‚ 20230901-zts-debug    #       â”œâ”€ðŸ“‚ 20230901-zts-debug  # PHP shared extensions (*.so files)
      â””â”€ðŸ“‚ build                 #       â””â”€ðŸ“‚ build               # Various PHP development and build files
  â”œâ”€ðŸ“‚ ${sbindir}                #   â”œâ”€ðŸ“‚ sbin                    # Executable binaries for root privileges
  â””â”€ðŸ“‚ ${datarootdir}            #   â””â”€ðŸ“‚ share                   # Directory with shareable files
    â””â”€ðŸ“‚ ${mandir}               #     â””â”€ðŸ“‚ man
      â”œâ”€ðŸ“‚ man1                  #       â”œâ”€ðŸ“‚ man1                # PHP man section 1 pages for *nix systems
      â””â”€ðŸ“‚ man8                  #       â””â”€ðŸ“‚ man8                # PHP man section 8 pages for *nix systems
    â”œâ”€ðŸ“‚ ${PHP_PEAR}             #     â”œâ”€ðŸ“‚ pear                  # PEAR installation directory
    â””â”€ðŸ“‚ php                     #     â””â”€ðŸ“‚ php
      â””â”€ðŸ“‚ fpm                   #       â””â”€ðŸ“‚ fpm                 # Additional FPM static HTML files
  â””â”€ðŸ“‚ ${localstatedir}          #   â””â”€ðŸ“‚ var                     # The Linux var directory
    â””â”€ðŸ“‚ log                     #     â””â”€ðŸ“‚ log                   # Directory for PHP logs
  â””â”€ðŸ“‚ ${runstatedir}            #   â””â”€ðŸ“‚ var/run                 # Runtime data directory
ðŸ“¦ /                             # ðŸ“¦ /                           # System top level root directory
â””â”€ðŸ“‚ tmp                         # â””â”€ðŸ“‚ tmp                       # System temporary directory
  â””â”€ðŸ“‚ pear                      #   â””â”€ðŸ“‚ pear                    # PEAR temporary directory
    â”œâ”€ðŸ“‚ cache                   #     â”œâ”€ðŸ“‚ cache
    â”œâ”€ðŸ“‚ download                #     â”œâ”€ðŸ“‚ download
    â””â”€ðŸ“‚ temp                    #     â””â”€ðŸ“‚ temp
```

This is how the default PHP layout directory structure looks like
(`--with-layout=PHP`). Notice the difference of the shared extensions directory
and the `share` directory being named `php`:

```sh
ðŸ“¦ <INSTALL_ROOT>
â””â”€ðŸ“‚ /usr/local
  â”œâ”€ðŸ“‚ bin
  â””â”€ðŸ“‚ etc
    â”œâ”€ðŸ“‚ php-fpm.d
    â”œâ”€ðŸ“„ pear.conf
    â””â”€ðŸ“„ php-fpm.conf.default
  â””â”€ðŸ“‚ include
    â””â”€ðŸ“‚ php
      â”œâ”€ðŸ“‚ ext
      â”œâ”€ðŸ“‚ main
      â”œâ”€ðŸ“‚ sapi
      â”œâ”€ðŸ“‚ TSRM
      â””â”€ðŸ“‚ Zend
  â””â”€ðŸ“‚ lib
    â””â”€ðŸ“‚ php
      â”œâ”€ðŸ“‚ build
      â””â”€ðŸ“‚ extensions
        â””â”€ðŸ“‚ no-debug-non-zts-20230901  # PHP shared extensions (*.so files)
  â””â”€ðŸ“‚ php                              # Directory with shareable files
    â””â”€ðŸ“‚ man
      â”œâ”€ðŸ“‚ man1
      â””â”€ðŸ“‚ man8
    â””â”€ðŸ“‚ php
      â””â”€ðŸ“‚ fpm
  â”œâ”€ðŸ“‚ sbin
  â””â”€ðŸ“‚ var
    â”œâ”€ðŸ“‚ log
    â””â”€ðŸ“‚ run
ðŸ“¦ /
â””â”€ðŸ“‚ tmp
  â””â”€ðŸ“‚ pear
    â””â”€ðŸ“‚ temp
```

## 11. See more

Useful resources to learn more about Autoconf and Autotools in general:

* [Autoconf documentation](https://www.gnu.org/software/autoconf/manual/)
* [Autotools Mythbuster](https://autotools.info/) - guide to Autotools
